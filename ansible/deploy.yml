- name: Déployer l'API sur GCP
  hosts: api
  become: yes

  vars:
    gh_pat: "{{ gh_pat | default(lookup('env', 'GH_PAT')) }}"
    repo_url: "https://{{ gh_pat }}@github.com/temp-account-vm/gcp-ci-cd-api.git"
    app_root: "/home/debian/api"

  tasks:
    - name: Install dependencies
      apt:
        name:
          - curl
          - git
        state: present
        update_cache: yes

    - name: Ajouter le dépôt NodeSource pour Node.js 22
      shell: curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      args:
        executable: /bin/bash

    - name: Installer Node.js 22 et npm 10
      apt:
        name: nodejs
        state: present

    - name: Vérifier la version de node
      command: node -v
      register: node_version
    - debug:
        var: node_version.stdout

    - name: Vérifier la version de npm
      command: npm -v
      register: npm_version
    - debug:
        var: npm_version.stdout

    - name: Ensure app directory exists
      file:
        path: "{{ app_root }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Cloner ou mettre à jour le repo
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_root }}"
        version: main
        force: yes
      no_log: true

    - name: Installer les dépendances
      npm:
        path: "{{ app_root }}/api"
        production: yes

    - name: Start app with PM2
      shell: |
        npm install -g pm2
        cd {{ app_root }}/api
        pm2 start index.js --name my-api || pm2 restart my-api
        pm2 save
      args:
        executable: /bin/bash
